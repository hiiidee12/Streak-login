<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Check-in via Wallet Transaction</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f17; color:#e7eefc; }
    .container { max-width: 460px; margin: 0 auto; padding: 16px; }
    .card {
      background:#121a2a;
      border:1px solid #22304d;
      border-radius:16px;
      padding:14px;
      margin:12px 0;
    }
    h1 { font-size:18px; margin:0 0 8px; }
    .muted { opacity:.85; font-size:13px; line-height:1.4; }
    .row { display:flex; gap:10px; margin-top:10px; }
    button {
      flex:1;
      padding:12px;
      border-radius:14px;
      border:1px solid #2a3a5d;
      background:#1a2a4a;
      color:#e7eefc;
      font-weight:800;
      cursor:pointer;
    }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .badge {
      display:inline-block;
      padding:6px 10px;
      border:1px solid #2a3a5d;
      border-radius:999px;
      font-size:12px;
    }
    .ok { color:#7CFFB2; }
    .warn { color:#FFD37C; }
    .err { color:#FF8A8A; }
    .hr { height:1px; background:#22304d; margin:12px 0; }
    code { font-size:12px; }
  </style>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>

<body>
  <div class="container">

    <div class="card">
      <h1>Daily Check-in (Wallet Transaction)</h1>
      <div class="muted">
        Demo app: daily check-in triggers a <b>0 ETH transaction</b> to your own wallet.
        <span class="warn"><b>Gas fees apply.</b></span><br />
        Check-in status is stored in <code>localStorage</code> (demo only, not secure).
      </div>

      <div class="hr"></div>

      <div>
        <div class="muted">Wallet Address</div>
        <div id="addr" class="badge">Not connected</div>
      </div>

      <div style="margin-top:10px;">
        <div class="muted">Network</div>
        <div id="net" class="badge">-</div>
      </div>

      <div class="row">
        <button id="connectBtn">Connect Wallet</button>
        <button id="checkinBtn" disabled>Daily Check-in (Tx)</button>
      </div>

      <div style="margin-top:10px" class="muted">
        Status: <span id="status" class="badge">Idle</span>
      </div>
    </div>

    <div class="card">
      <div class="muted"><b>Important Notes</b></div>
      <ul class="muted">
        <li>This is <b>not secure</b> without a smart contract or backend verification.</li>
        <li>Production version should use a smart contract (e.g. <code>checkIn()</code>).</li>
      </ul>
    </div>

  </div>

  <script>
    // ===== CONFIG =====
    const TARGET_CHAIN = {
      chainIdHex: "0x2105", // Base Mainnet (8453)
      chainName: "Base Mainnet",
      nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
      rpcUrls: ["https://mainnet.base.org"],
      blockExplorerUrls: ["https://basescan.org"]
    };

    const LS_KEY = "daily_checkin_last_date";

    let provider, signer, userAddress;
    const $ = (id) => document.getElementById(id);

    function setStatus(text, cls) {
      $("status").textContent = text;
      $("status").className = "badge " + (cls || "");
    }

    function todayKey() {
      return new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    }

    function hasCheckedInToday() {
      return localStorage.getItem(LS_KEY) === todayKey();
    }

    function updateCheckinButton() {
      const checked = hasCheckedInToday();
      $("checkinBtn").disabled = !userAddress || checked;
      $("checkinBtn").textContent = checked
        ? "Already checked in today ✅"
        : "Daily Check-in (Tx)";
    }

    async function ensureChain() {
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: TARGET_CHAIN.chainIdHex }]
        });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [TARGET_CHAIN]
          });
        }
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert("No wallet detected. Please install MetaMask or a Web3 wallet.");
        return;
      }

      setStatus("Connecting...", "warn");

      await ensureChain();

      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      const accounts = await provider.send("eth_requestAccounts", []);
      userAddress = accounts[0];
      signer = provider.getSigner();

      $("addr").textContent =
        userAddress.slice(0, 6) + "..." + userAddress.slice(-4);

      const net = await provider.getNetwork();
      $("net").textContent = `${net.name} (chainId ${net.chainId})`;

      setStatus("Connected", "ok");
      updateCheckinButton();
    }

    async function dailyCheckin() {
      if (hasCheckedInToday()) return;

      const ok = confirm(
        "This will send a 0 ETH transaction and still costs gas. Continue?"
      );
      if (!ok) return;

      try {
        setStatus("Sending transaction...", "warn");

        const data = ethers.utils.hexlify(
          ethers.utils.toUtf8Bytes("DAILY_CHECKIN:" + todayKey())
        );

        const tx = await signer.sendTransaction({
          to: userAddress,
          value: ethers.constants.Zero,
          data
        });

        setStatus("Waiting for confirmation...", "warn");
        await tx.wait(1);

        localStorage.setItem(LS_KEY, todayKey());

        setStatus("Daily check-in successful ✅", "ok");
        updateCheckinButton();

        alert("Check-in successful!\nTx hash:\n" + tx.hash);
      } catch (e) {
        console.error(e);
        setStatus("Transaction failed", "err");
        alert(e.message || "Transaction rejected");
      }
    }

    $("connectBtn").onclick = connectWallet;
    $("checkinBtn").onclick = dailyCheckin;

    updateCheckinButton();

    if (window.ethereum) {
      window.ethereum.on("accountsChanged", () => location.reload());
      window.ethereum.on("chainChanged", () => location.reload());
    }
  </script>
</body>
</html>
