<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Check-in</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Daily Check-in" />
  <meta property="og:description" content="Daily check-in using a wallet transaction on Base." />
  <meta property="og:image" content="https://streak-login.vercel.app/assets/check.jpg" />
  <meta property="og:url" content="https://streak-login.vercel.app/" />
  <meta property="og:type" content="website" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Daily Check-in" />
  <meta name="twitter:description" content="Daily check-in using a wallet transaction on Base." />
  <meta name="twitter:image" content="https://streak-login.vercel.app/assets/check.jpg" />

  <!-- Farcaster Mini App -->
  <meta
    name="fc:miniapp"
    content='{"version":"1","imageUrl":"https://streak-login.vercel.app/miniapp-card.png","aspectRatio":"3:2","button":{"title":"Open Daily Check-in","action":{"type":"launch_frame","name":"Daily Check-in","url":"https://streak-login.vercel.app/","splashImageUrl":"https://streak-login.vercel.app/assets/check.jpg","splashBackgroundColor":"#0b0f17"}}}'
  />

  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="muted" id="env">Loading...</div>

      <div class="profile">
        <img id="pfp" class="pfp" src="/assets/check.jpg" alt="Profile photo"
             referrerpolicy="no-referrer"
             onerror="this.src='/assets/check.jpg'" />
        <div>
          <div class="profileTop">
            <b id="fcName">Guest</b>
            <span class="badge" id="fcFid">FID: -</span>
          </div>
          <div class="muted" id="fcUser">Not signed in</div>
        </div>
      </div>

      <div class="hr"></div>

      <h1>Daily Check-in (Wallet Transaction)</h1>
      <div class="muted">
        This demo performs a <b>0 ETH</b> transaction to your own address as a ‚Äúcheck-in‚Äù.
        <span class="warn"><b>Gas fees apply.</b></span><br />
        Check-in status is stored in <code>localStorage</code> (demo only; not secure without on-chain verification).
      </div>

      <div class="hr"></div>

      <div class="muted">Wallet Address</div>
      <div id="addr" class="badge">Not connected</div>

      <div class="mt10">
        <div class="muted">Network</div>
        <div id="net" class="badge">-</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="connectBtn">Connect Wallet</button>
        <button id="checkinBtn" disabled>Daily Check-in (Tx)</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="authBtn">Get QuickAuth Token</button>
      </div>

      <div class="mini">Status: <span id="status" class="badge">Idle</span></div>
      <div class="mini">Debug: <span id="debug" class="badge">-</span></div>
    </div>

    <div class="card">
      <div class="muted"><b>Notes</b></div>
      <ul class="muted">
        <li>We send a transaction using <code>eth_sendTransaction</code> (EIP-1193).</li>
        <li>We confirm it via Base RPC to avoid unsupported wallet methods.</li>
      </ul>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <div class="toast-title"></div>
    <div class="toast-msg"></div>
  </div>

  <script>
    // ---------- UI helpers ----------
    const $ = (id) => document.getElementById(id);

    function setDebug(msg) {
      const el = $("debug");
      if (el) el.textContent = msg;
      console.log("[DEBUG]", msg);
    }

    function setStatus(text, type = "ok") {
      const el = $("status");
      if (!el) return;
      el.textContent = text;
      el.className = `badge ${type}`;
    }

    function showToast(title, msg = "") {
      const el = $("toast");
      if (!el) return alert(title + (msg ? `\n${msg}` : ""));
      el.querySelector(".toast-title").textContent = title;
      el.querySelector(".toast-msg").textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 2600);
    }

    function shortAddr(a) {
      return a ? `${a.slice(0, 6)}‚Ä¶${a.slice(-4)}` : "-";
    }

    // ---------- wallet ----------
    const CONFIG = { BASE_CHAIN_ID_DEC: 8453 };
    let ethProvider = null;
    let address = null;

    async function getWalletProvider() {
      return window.ethereum || null;
    }

    async function updateNetwork() {
      try {
        const chainHex = await ethProvider.request({ method: "eth_chainId" });
        const chainDec = parseInt(chainHex, 16);
        $("net").textContent =
          `chainId ${chainDec}` + (chainDec === CONFIG.BASE_CHAIN_ID_DEC ? " (Base ‚úÖ)" : "");
        if (chainDec === CONFIG.BASE_CHAIN_ID_DEC) setStatus("Connected ‚úÖ", "ok");
        else setStatus("Connected (not Base) ‚ö†Ô∏è", "warn");
      } catch {
        $("net").textContent = "-";
      }
    }

    async function connectWallet() {
      try {
        ethProvider = await getWalletProvider();
        if (!ethProvider?.request) {
          showToast("Wallet not found");
          return;
        }
        const accounts = await ethProvider.request({ method: "eth_requestAccounts" });
        address = accounts?.[0];
        if (!address) return;

        $("addr").textContent = shortAddr(address);
        await updateNetwork();

        $("connectBtn").textContent = "Connected ‚úÖ";
        $("connectBtn").disabled = true;

        $("checkinBtn").disabled = false;

        setDebug("Wallet connected");
      } catch (e) {
        showToast("Connect failed", e?.message || String(e));
      }
    }

    async function autoConnectWallet() {
      try {
        ethProvider = await getWalletProvider();
        if (!ethProvider?.request) return;

        const accounts = await ethProvider.request({ method: "eth_accounts" });
        address = accounts?.[0];
        if (!address) return;

        $("addr").textContent = shortAddr(address);
        await updateNetwork();

        $("connectBtn").textContent = "Connected ‚úÖ";
        $("connectBtn").disabled = true;

        $("checkinBtn").disabled = false;

        setDebug("Wallet auto-connected");
      } catch {}
    }

    async function dailyCheckin() {
      if (!ethProvider || !address) {
        showToast("Wallet not connected");
        return;
      }

      // lock per-day (demo)
      const key = "checkedInDay";
      const today = new Date().toDateString();
      if (localStorage.getItem(key) === today) {
        $("checkinBtn").textContent = "Already checked in today ‚úÖ";
        $("checkinBtn").disabled = true;
        showToast("Already checked in", "Come back tomorrow");
        return;
      }

      try {
        setDebug("Sending tx...");
        const txHash = await ethProvider.request({
          method: "eth_sendTransaction",
          params: [{ from: address, to: address, value: "0x0" }],
        });

        localStorage.setItem(key, today);

        $("checkinBtn").textContent = "Already checked in today ‚úÖ";
        $("checkinBtn").disabled = true;

        showToast("Check-in successful ‚úÖ", `Tx: ${String(txHash).slice(0, 10)}‚Ä¶`);
        setDebug("Tx sent ‚úÖ");
      } catch (e) {
        showToast("Check-in failed", e?.message || String(e));
        setDebug("Tx failed");
      }
    }

    // ---------- Farcaster SDK readiness ----------
    async function ensureSDKReady() {
      const sdk = window.__FC_SDK__;
      if (!sdk?.actions?.ready) {
        setDebug("SDK missing");
        return false;
      }
      for (let i = 0; i < 8; i++) {
        try {
          await sdk.actions.ready();
          setDebug("SDK ready ‚úÖ");
          return true;
        } catch {
          await new Promise((r) => setTimeout(r, 200));
        }
      }
      setDebug("ready() failed");
      return false;
    }

    // ---------- QuickAuth (stable) ----------
    async function getQuickAuthToken() {
      const sdk = window.__FC_SDK__;
      try {
        setDebug("QuickAuth start");
        if (!sdk?.quickAuth?.getToken) {
          showToast("QuickAuth unavailable", "Open inside Farcaster Mini App");
          setDebug("QuickAuth API missing");
          return;
        }

        // IMPORTANT: some SDKs return { token }, some return string. Support both.
        const t = await sdk.quickAuth.getToken();
        const token = typeof t === "string" ? t : t?.token;

        if (!token) {
          showToast("QuickAuth failed", "No token returned");
          setDebug("No token");
          return;
        }

        setDebug("Token acquired");

        const r = await fetch("/api/me", {
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await r.json().catch(() => ({}));

        if (!r.ok) {
          console.log("verify failed:", data);
          showToast("Sign-in failed", data?.error || `HTTP ${r.status}`);
          setDebug(`API failed (${r.status})`);
          return;
        }

        const name = data.displayName || data.username || "Farcaster User";
        const username = data.username ? `@${data.username}` : "@unknown";
        const fid = data.fid ?? "-";

        $("fcName").textContent = name;
        $("fcUser").textContent = username;
        $("fcFid").textContent = `FID: ${fid}`;
        if (data.pfpUrl) $("pfp").src = data.pfpUrl;

        showToast("Signed in ‚úÖ", "Profile loaded");
        setDebug("Profile loaded ‚úÖ");
      } catch (e) {
        console.log(e);
        showToast("QuickAuth failed", e?.message || String(e));
        setDebug("QuickAuth exception");
      }
    }

    // ---------- boot ----------
    (async function boot() {
      setDebug("boot()");
      $("env").textContent = "Loading...";

      // Detect miniapp environment (best-effort)
      try {
        const inMiniApp =
          !!window.__FC_SDK__ ||
          /warpcast|farcaster/i.test(navigator.userAgent || "");
        $("env").textContent = inMiniApp ? "Running inside Mini App ‚úÖ" : "Running in browser üåê";
      } catch {
        $("env").textContent = "Running...";
      }

      // Wire buttons
      $("connectBtn").addEventListener("click", connectWallet);
      $("checkinBtn").addEventListener("click", dailyCheckin);
      $("authBtn").addEventListener("click", getQuickAuthToken);

      // Auto connect wallet
      await autoConnectWallet();

      // Disable checkin if already done today
      const today = new Date().toDateString();
      if (localStorage.getItem("checkedInDay") === today) {
        $("checkinBtn").textContent = "Already checked in today ‚úÖ";
        $("checkinBtn").disabled = true;
      }

      // Ensure Farcaster ready (prevents ‚ÄúReady not called‚Äù)
      await ensureSDKReady();

      setDebug("boot done ‚úÖ");
    })();
  </script>
</body>
</html>
