<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Check-in</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Daily Check-in" />
  <meta property="og:description" content="Daily check-in using a wallet transaction on Base." />
  <meta property="og:image" content="https://streak-login.vercel.app/assets/check.jpg" />
  <meta property="og:url" content="https://streak-login.vercel.app/" />
  <meta property="og:type" content="website" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Daily Check-in" />
  <meta name="twitter:description" content="Daily check-in using a wallet transaction on Base." />
  <meta name="twitter:image" content="https://streak-login.vercel.app/assets/check.jpg" />

  <!-- Farcaster Mini App -->
  <!-- NOTE: imageUrl should ideally be 3:2 (e.g., 1200x800). Upload /miniapp-card.png if you can. -->
  <meta
    name="fc:miniapp"
    content='{"version":"1","imageUrl":"https://streak-login.vercel.app/miniapp-card.png","button":{"title":"Open Daily Check-in","action":{"type":"launch_frame","name":"Daily Check-in","url":"https://streak-login.vercel.app/","splashImageUrl":"https://streak-login.vercel.app/assets/check.jpg","splashBackgroundColor":"#0b0f17"}}}'
  />

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f17; color:#e7eefc; }
    .container { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card {
      background:#121a2a;
      border:1px solid #22304d;
      border-radius:16px;
      padding:14px;
      margin:12px 0;
    }
    h1 { font-size:18px; margin:0 0 8px; }
    .muted { opacity:.86; font-size:13px; line-height:1.45; }
    .row { display:flex; gap:10px; margin-top:10px; flex-wrap: wrap; }
    button {
      flex: 1;
      min-width: 170px;
      padding:12px;
      border-radius:14px;
      border:1px solid #2a3a5d;
      background:#1a2a4a;
      color:#e7eefc;
      font-weight:800;
      cursor:pointer;
    }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .badge {
      display:inline-block;
      padding:6px 10px;
      border:1px solid #2a3a5d;
      border-radius:999px;
      font-size:12px;
      word-break: break-word;
    }
    .ok { color:#7CFFB2; }
    .warn { color:#FFD37C; }
    .err { color:#FF8A8A; }
    .hr { height:1px; background:#22304d; margin:12px 0; }
    .mini { font-size:12px; opacity:.8; margin-top:8px; }
    .profile { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .pfp { width:44px; height:44px; border-radius:999px; border:1px solid #22304d; object-fit:cover; }
    code { font-size:12px; }
  </style>

  <!-- ethers.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>

<body>
  <div class="container">

    <div class="card">
      <!-- We will hide this automatically inside Mini App -->
      <div class="muted" id="env">Loading...</div>

      <div class="profile">
        <img id="pfp" class="pfp" src="https://streak-login.vercel.app/assets/check.jpg" alt="pfp" />
        <div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <b id="fcName">-</b>
            <span class="badge" id="fcFid">FID: -</span>
          </div>
          <div class="muted" id="fcUser">@-</div>
        </div>
      </div>

      <div class="hr"></div>

      <h1>Daily Check-in (Wallet Transaction)</h1>
      <div class="muted">
        This demo performs a <b>0 ETH</b> transaction to your own address as a ‚Äúcheck-in‚Äù.
        <span class="warn"><b>Gas fees apply.</b></span><br />
        Check-in status is stored in <code>localStorage</code> (demo only; not secure without on-chain verification).
      </div>

      <div class="hr"></div>

      <div class="muted">Wallet Address</div>
      <div id="addr" class="badge">Not connected</div>

      <div style="margin-top:10px;">
        <div class="muted">Network</div>
        <div id="net" class="badge">-</div>
      </div>

      <div class="row">
        <button id="connectBtn">Connect Wallet</button>
        <button id="checkinBtn" disabled>Daily Check-in (Tx)</button>
        <button id="authBtn">Get QuickAuth Token</button>
      </div>

      <div class="mini">Status: <span id="status" class="badge">Idle</span></div>
    </div>

    <div class="card">
      <div class="muted"><b>Notes</b></div>
      <ul class="muted">
        <li>If opened inside a Mini App webview, <code>window.ethereum</code> may not exist.</li>
        <li>Production version should use a smart contract (e.g. <code>checkIn()</code>) or verify the tx on a backend.</li>
      </ul>
    </div>

  </div>

  <script type="module">
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";
    const ethers = window.ethers;

    const BASE_CHAIN_HEX = "0x2105"; // Base Mainnet (8453)
    const LS_KEY = "daily_checkin_last_date";

    let provider, signer, address;

    const $ = (id) => document.getElementById(id);

    function setStatus(text, cls = "") {
      $("status").textContent = text;
      $("status").className = "badge " + cls;
    }

    function todayKeyUTC() {
      return new Date().toISOString().slice(0, 10);
    }

    function hasCheckedInToday() {
      return localStorage.getItem(LS_KEY) === todayKeyUTC();
    }

    function shortAddr(a) {
      return a ? `${a.slice(0, 6)}...${a.slice(-4)}` : "";
    }

    function updateButtons() {
      const checked = hasCheckedInToday();
      $("checkinBtn").disabled = !address || checked;
      $("checkinBtn").textContent = checked ? "Already checked in today ‚úÖ" : "Daily Check-in (Tx)";
    }

    function setConnectButtonConnected(isConnected) {
      const btn = $("connectBtn");
      if (!btn) return;

      if (isConnected) {
        btn.textContent = "Connected ‚úÖ";
        btn.disabled = true;
      } else {
        btn.textContent = "Connect Wallet";
        btn.disabled = false;
      }
    }

    async function safeGetContext() {
      // Prefer sdk.getContext() if available; fallback to sdk.context
      try {
        if (typeof sdk.getContext === "function") return await sdk.getContext();
      } catch {}
      try {
        return sdk.context;
      } catch {}
      return null;
    }

    async function loadFarcasterProfile() {
      try {
        const inMini = await sdk.isInMiniApp();

        // Hide env banner inside Mini App (removes "Running inside Mini App ‚úÖ")
        if (inMini) {
          $("env").style.display = "none";
        } else {
          $("env").style.display = "block";
          $("env").textContent = "Running in normal browser üåê";
        }

        if (inMini) {
          const ctx = await safeGetContext();
          const user = ctx?.user;

          if (user) {
            $("fcName").textContent = user.displayName || user.username || "Farcaster User";
            $("fcUser").textContent = "@" + (user.username || "unknown");
            $("fcFid").textContent = "FID: " + (user.fid ?? "-");
            if (user.pfpUrl) $("pfp").src = user.pfpUrl;
          }

          // Hide splash once UI is ready
          try { await sdk.actions.ready(); } catch {}
        }
      } catch (e) {
        $("env").style.display = "none";
      }
    }

    async function getWalletProvider() {
      // Best-effort across SDK versions
      try {
        if (sdk?.wallet?.getEthereumProvider) {
          const p = await sdk.wallet.getEthereumProvider();
          if (p) return p;
        }
      } catch {}
      try { if (sdk?.wallet?.ethereum) return sdk.wallet.ethereum; } catch {}
      try { if (sdk?.ethereum) return sdk.ethereum; } catch {}
      return window.ethereum || null;
    }

    async function connectWallet() {
      setStatus("Connecting...", "warn");
      setConnectButtonConnected(false);

      const walletProvider = await getWalletProvider();
      if (!walletProvider) {
        setStatus("No wallet provider found", "err");
        alert("No wallet provider found. Open inside Warpcast Mini App or install MetaMask.");
        return;
      }

      provider = new ethers.providers.Web3Provider(walletProvider, "any");

      let accounts = [];
      try {
        accounts = await provider.send("eth_requestAccounts", []);
      } catch (e) {
        setStatus("Wallet connection rejected", "err");
        setConnectButtonConnected(false);
        alert(e?.message || "Wallet connection rejected");
        return;
      }

      address = accounts?.[0] || "";
      if (!address) {
        setStatus("No account returned", "err");
        setConnectButtonConnected(false);
        return;
      }

      signer = provider.getSigner();

      $("addr").textContent = shortAddr(address);

      // Try switch to Base (not all providers support this method)
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: BASE_CHAIN_HEX }]);
      } catch {}

      // Show network (fallback text if provider doesn't report a name)
      try {
        const net = await provider.getNetwork();
        const name = (net?.name && net.name !== "unknown") ? net.name : "unknown";
        $("net").textContent = `${name} (chainId ${net.chainId})`;
      } catch {
        $("net").textContent = "-";
      }

      setStatus("Connected ‚úÖ", "ok");
      setConnectButtonConnected(true);
      updateButtons();

      // Ensure splash dismissed (Mini App)
      try { await sdk.actions.ready(); } catch {}
    }

    async function dailyCheckin() {
      if (!signer || !address) return;

      if (hasCheckedInToday()) {
        setStatus("Already checked in today ‚úÖ", "ok");
        updateButtons();
        return;
      }

      const ok = confirm("This will send a 0 ETH transaction and still costs gas. Continue?");
      if (!ok) return;

      setStatus("Sending transaction...", "warn");

      const data = ethers.utils.hexlify(
        ethers.utils.toUtf8Bytes("DAILY_CHECKIN:" + todayKeyUTC())
      );

      try {
        const tx = await signer.sendTransaction({
          to: address,
          value: ethers.constants.Zero,
          data
        });

        setStatus("Waiting for confirmation...", "warn");
        await tx.wait(1);

        localStorage.setItem(LS_KEY, todayKeyUTC());
        updateButtons();

        setStatus("Daily check-in successful ‚úÖ", "ok");
        alert("Check-in successful!\nTx hash:\n" + tx.hash);
      } catch (e) {
        console.error(e);
        setStatus("Transaction failed ‚ùå", "err");
        alert(e?.message || "Transaction rejected");
      }
    }

    async function getQuickAuthToken() {
      try {
        const token = await sdk.quickAuth.getToken();
        console.log("QuickAuth token:", token);
        alert("QuickAuth token printed to console.");
      } catch (e) {
        alert("Quick Auth failed: " + (e?.message || e));
      }
    }

    // Wire up
    $("connectBtn").onclick = connectWallet;
    $("checkinBtn").onclick = dailyCheckin;
    $("authBtn").onclick = getQuickAuthToken;

    // Init
    setConnectButtonConnected(false);
    updateButtons();
    await loadFarcasterProfile();

    // Optional: if user opens outside Mini App with MetaMask, listen for changes
    if (window.ethereum?.on) {
      window.ethereum.on("accountsChanged", () => location.reload());
      window.ethereum.on("chainChanged", () => location.reload());
    }
  </script>
</body>
</html>
