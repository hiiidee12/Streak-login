<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Check-in</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Daily Check-in" />
  <meta property="og:description" content="Daily check-in using a wallet transaction on Base." />
  <meta property="og:image" content="https://streak-login.vercel.app/assets/check.jpg" />
  <meta property="og:url" content="https://streak-login.vercel.app/" />
  <meta property="og:type" content="website" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Daily Check-in" />
  <meta name="twitter:description" content="Daily check-in using a wallet transaction on Base." />
  <meta name="twitter:image" content="https://streak-login.vercel.app/assets/check.jpg" />

  <!-- Farcaster Mini App -->
  <meta
    name="fc:miniapp"
    content='{"version":"1","imageUrl":"https://streak-login.vercel.app/miniapp-card.png","aspectRatio":"3:2","button":{"title":"Open Daily Check-in","action":{"type":"launch_frame","name":"Daily Check-in","url":"https://streak-login.vercel.app/","splashImageUrl":"https://streak-login.vercel.app/assets/check.jpg","splashBackgroundColor":"#0b0f17"}}}'
  />

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:0; background:#0b0f17; color:#e7eefc; }
    .container { max-width: 520px; margin: 0 auto; padding: 16px; }
    .card { background:#121a2a; border:1px solid #22304d; border-radius:16px; padding:14px; margin:12px 0; }
    h1 { font-size:18px; margin:0 0 8px; }
    .muted { opacity:.86; font-size:13px; line-height:1.45; }
    .row { display:flex; gap:10px; margin-top:10px; flex-wrap: wrap; }
    button {
      flex: 1; min-width: 170px; padding:12px; border-radius:14px;
      border:1px solid #2a3a5d; background:#1a2a4a; color:#e7eefc; font-weight:800; cursor:pointer;
    }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .badge { display:inline-block; padding:6px 10px; border:1px solid #2a3a5d; border-radius:999px; font-size:12px; word-break: break-word; }
    .ok { color:#7CFFB2; }
    .warn { color:#FFD37C; }
    .err { color:#FF8A8A; }
    .hr { height:1px; background:#22304d; margin:12px 0; }
    .mini { font-size:12px; opacity:.8; margin-top:8px; }
    .profile { display:flex; gap:10px; align-items:center; margin-top:10px; }
    .pfp { width:44px; height:44px; border-radius:999px; border:1px solid #22304d; object-fit:cover; }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="muted" id="env">Loading...</div>

      <div class="profile">
        <img id="pfp" class="pfp" src="https://streak-login.vercel.app/assets/check.jpg" alt="pfp" />
        <div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <b id="fcName">-</b>
            <span class="badge" id="fcFid">FID: -</span>
          </div>
          <div class="muted" id="fcUser">@-</div>
        </div>
      </div>

      <div class="hr"></div>

      <h1>Daily Check-in (On-chain)</h1>
      <div class="muted">
        Check-in via smart contract on <b>Base</b>.
        Reward is sent from contract balance.
        <span class="warn"><b>Gas fees apply.</b></span>
      </div>

      <div class="hr"></div>

      <div class="muted">Wallet Address</div>
      <div id="addr" class="badge">Not connected</div>

      <div style="margin-top:10px;">
        <div class="muted">Network</div>
        <div id="net" class="badge">-</div>
      </div>

      <div class="row">
        <button id="connectBtn">Connect Wallet</button>
        <button id="checkinBtn" disabled>Daily Check-in</button>
        <button id="authBtn">Get QuickAuth Token</button>
      </div>

      <div class="mini">Status: <span id="status" class="badge">Idle</span></div>
    </div>
  </div>

  <script type="module">
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";

    const BASE_CHAIN_ID = 8453;
    const LS_KEY = "daily_checkin_last_date";

    // üîó SMART CONTRACT
    const CHECKIN_CONTRACT = "0x2a15A134f8D88e79e8053371c32Dd77B53e79e6d";
    const CHECKIN_ABI = [
      "function checkIn() external",
      "function canCheckIn(address) view returns (bool)"
    ];

    let ethProvider = null;
    let address = "";

    const $ = (id) => document.getElementById(id);

    function setStatus(text, cls="") {
      $("status").textContent = text;
      $("status").className = "badge " + cls;
    }

    function shortAddr(a) {
      return a ? a.slice(0,6) + "..." + a.slice(-4) : "";
    }

    function updateButtons() {
      $("checkinBtn").disabled = !address;
    }

    async function loadFarcasterProfile() {
      try {
        const inMini = await sdk.isInMiniApp();
        $("env").textContent = inMini ? "Running in Farcaster Mini App" : "Running in browser üåê";
        if (inMini) {
          const ctx = await sdk.getContext();
          const u = ctx?.user;
          if (u) {
            $("fcName").textContent = u.displayName || u.username;
            $("fcUser").textContent = "@" + (u.username || "");
            $("fcFid").textContent = "FID: " + u.fid;
            if (u.pfpUrl) $("pfp").src = u.pfpUrl;
          }
          try { await sdk.actions.ready(); } catch {}
        }
      } catch {}
    }

    async function connectWallet() {
      ethProvider = window.ethereum || await sdk.wallet.getEthereumProvider();
      if (!ethProvider) return alert("No wallet provider found");

      const accounts = await ethProvider.request({ method: "eth_requestAccounts" });
      address = accounts[0];
      $("addr").textContent = shortAddr(address);

      const chainId = parseInt(await ethProvider.request({ method: "eth_chainId" }), 16);
      $("net").textContent = chainId === BASE_CHAIN_ID ? "Base ‚úÖ" : "Wrong network ‚ùå";

      if (chainId !== BASE_CHAIN_ID) {
        setStatus("Please switch to Base", "err");
        return;
      }

      setStatus("Connected", "ok");
      updateButtons();
    }

    async function dailyCheckin() {
      try {
        const provider = new ethers.BrowserProvider(ethProvider);
        const signer = await provider.getSigner();
        const contract = new ethers.Contract(CHECKIN_CONTRACT, CHECKIN_ABI, signer);

        const can = await contract.canCheckIn(address);
        if (!can) {
          setStatus("Already checked in today ‚úÖ", "ok");
          return;
        }

        setStatus("Sending transaction...", "warn");
        const tx = await contract.checkIn();
        await tx.wait();

        localStorage.setItem(LS_KEY, new Date().toISOString().slice(0,10));
        setStatus("Check-in success üéâ", "ok");
        alert("Check-in successful!");
      } catch (e) {
        setStatus("Check-in failed ‚ùå", "err");
        alert(e?.reason || e?.message || e);
      }
    }

    async function getQuickAuthToken() {
      try {
        const token = await sdk.quickAuth.getToken();
        console.log("QuickAuth token:", token);
        alert("QuickAuth token printed to console.");
      } catch (e) {
        alert("Quick Auth failed: " + (e?.message || e));
      }
    }

    $("connectBtn").onclick = connectWallet;
    $("checkinBtn").onclick = dailyCheckin;
    $("authBtn").onclick = getQuickAuthToken;

    updateButtons();
    await loadFarcasterProfile();
  </script>
</body>
</html>
